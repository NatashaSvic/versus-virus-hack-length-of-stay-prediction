---
title: "**Prediction of occupancy of an ICU bed**"
output: 
  html_document:
    css: css/main.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Useful packages
library(jsonlite)
library(tidyverse)
library(here)
library(survival)
library(lubridate)
library(MASS)
```

<img src = "logo.png" alt="My Logo" style="float:right;width:150px;height:150;">

# Background

The <span style="color:#2B7ACA">_**BlueBeds**_</span> platform is supposed to provide information on the availability of ICU beds in Switzerland. At admission of a patient to the ICU, a member of the hospital staff will block the bed, the patient is put in. Further some baseline patient characteristics are provided to the platform. In a next step, using these patient characteristics together with some bed-level information and hospital-level data the platform predicts the length-of-stay of the patient and therefore a time window for which the bed will be occupied. This data will help with hospital resource management. As this platform can be accessed Swiss-wide and the data is anonymised, it further provides real-time information on availability of beds, which can help to reallocate patients in between cities or even cantons.

# Data collection
The data used for the prediction of the length-of-stay (of the patient in the bed) will be collected by the platform itself. The usage of historical data for the initial predictions can be considered, so that predictions can be furnished right from the start. Note that the data recorded by the platform will be admission-specific, and for the prediction we are interested in the bed itself, and not in the individual patient. This ensures that we are not working with actual sensitive patient-data. The data collected by the platform will be the following (the selection is based on a literature review):

- unique identifier of the bed (`ID_BED`).
- unique identifier of the hospital (`ID_HOSPITAL`)
- date of admission of the patient (`ADMISSION_DATE`)
- date of discharge of the patient (`DISCHARGE_DATE`)
- length-of-stay of the patient (`LENGTH_OF_STAY`)
- gender of the patient (`GENDER`)
- age of the patient (`AGE`) (_can be changed to birth date instead, however due to data-privacy issue we prefer not to_)
- co-morbidities or preconditions of the patient (`COMORB`). This can be a text input, with listed co-morbidities separated by commas, so that the model can either use a binary variable for presence of preconditions (`PRESENCE_COMORB`) or even the number of different preconditions (`NB_COMORB`). 
- some Covid-19 related severity score as for example the [Brescia-COVID Respiratory Severity Scale](https://www.mdcalc.com/brescia-covid-respiratory-severity-scale-bcrss-algorithm)
- Covid-19 related symptoms or simply again the number of symptoms (`NB_SYMPTOMS`)


The hospital staff (doctor or nurse) interacts with the platform only twice: 

1. To find a bed and admit the patient to this bed. At this stage the doctor or nurse, sets the bed to occupied, fills in the baseline characteristics of the patient. The demographics on the bed, hospital, etc are automatically recorded by the platform. Also the admission date is automatically filled in by the platform.

2. When the patient is discharged from the bed. At this second stage, the doctor or nurse sets the bed to free and fills in the final stage of the patient (dead, alive, other).



```{r import-and-clean-up-data, warning= FALSE, message = FALSE}
patients <- readxl::read_xlsx(path = "data/TRAINING_DURATION_OF_STAY.xlsx") %>% 
  rename(PATIENT_ID = "...1",
         LENGTH_OF_STAY = "DUATION OF STAY",
         NB_COMORB = "# of pre_conditions",
         NB_SYMPTOMS = "# of symptoms",
         AGE = Age, 
         GENDER = Gender)

n_sample <- nrow(patients)

# set.seed(123)
# patients <- cbind(randomly_allocate_a_length_of_stay, 
#                   patients)
```

# Training and testing of the model

To evaluate the models and in the long-term maybe send alerts when the model is not performing anymore, the data is split into a train and a testing sample. The training data is composed of 75% of the sample. Note that in the long term this should be changed to cross-validation (*e.g* splitting the data several times).

```{r, echo = TRUE}
# Split into train and test
set.seed(1)
train_rows <- sample(1:n_sample, size = .75*n_sample)
train_patients <- patients[train_rows, ]
test_patients <- patients[-train_rows, ]
n_train <- nrow(train_patients)
n_test <- nrow(test_patients)
```

# Description of potential models
Once the product is running, data is collected and lessons have been learned, more sophisticated models can be looked at ($e.g$ machine learning). For the time-being and for a first prototype simple parametric regression models should be sufficient

## Simple Poisson regression model 
Since we want to predict the number of days a patient stays in the bed, this can be resolved with a simple count-data problem.
```{r poisson-model-training, echo = TRUE}
poisson_regression <- 
  glm(LENGTH_OF_STAY ~ GENDER + AGE + NB_SYMPTOMS + NB_COMORB,
      family = "poisson",data = train_patients)
```


## Negative-binomial regression model
An alternative to poisson regression are negative-binomial models.

```{r negbin-model-training, echo = TRUE, warning=FALSE}
negbin_regression <- 
  glm.nb(LENGTH_OF_STAY ~ GENDER + AGE + NB_SYMPTOMS + NB_COMORB,
         data = train_patients)
```

## Tree-based solutions

More non-parametric models should be looked at, once more data has been collected.

## Further modelling strategies
An ad-on output of the platform can be the prediction of the not only the time the patient leaves the bed, but further the chances of leaving the bed alive. This can be done using more sophisticated _time-to-event models_ after the data on the end-state of the patients at the time of 'leaving' the ICU bed is retrieved. As such, the platform can be seen as additional source for robust data collection to better understand the course of the disease. 

# Model building, performance testing and variable selection on the mock-data

## Mock data structure explained

Python was used to build a synthetic data set. The sample size is `r prettyNum(n_sample, big.mark="'")`. 
XXXXX

## Model building

## Model testing

To compare the model performances, let us use the root-mean-square error (RMSE). The RMSE is commonly used to measure differences between values predicted by a model and the values observed, where a lower score implies better accuracy. 

This model validation can also be used to update the models, add or drop variables, by judging whether they have had any predictive power.

Let's see how well that first poisson model performs:
```{r poisson-model-testing, echo = TRUE}
predict_los <- predict(poisson_regression, newdata = test_patients,
                       type = "response")
observed_los <- test_patients$LENGTH_OF_STAY

RMSE <- sqrt(sum((observed_los - predict_los)**2)/n_test)
RMSE
```


# Data-privacy issues to consider

To ensure the data being pseudo-anonymised, meaning making it impossible, or very hard to identify patients, we can consider the following further steps:

- Age-groups instead of exact age (<18, [18-29], [30-49], [50-64], [65-74], 75+)